---
title: "mixed_models"
output: pdf_document
---

```{r}
library(lmerTest) 
library(tidyverse)
library(modelsummary)
```

## No time element 
```{r}
df <- read.csv("/Users/amitsasson/PycharmProjects/DSSGx/final_dfs/df_final_with_clusters.csv")
head(df)
df$ags2 <- factor(df$ags2)
df$ags5 <- factor(df$ags5)
df$cluster <- factor(df$cluster)
```

#### without clutster/kreis
```{r}
fit1 <- lmer(mean_unemployment_rate ~ median_income + total_area + X2019_population + (1 | ags2), df)
summary(fit1)
get_gof(fit1)
```

#### with clutster
```{r}
fit2 <- lmer(mean_unemployment_rate ~ cluster + median_income  + total_area + X2019_population + (1 | ags2), df)
summary(fit2)
coef(fit2)
get_gof(fit2)
```


## Time data 

#### creating the dataset needed 
```{r}
df <- read.csv("/Users/amitsasson/PycharmProjects/DSSGx/final_dfs/df_final_without_labor_with_clusters.csv")
df %>% select(cluster) %>% table()
df <- df %>% select(-data_index)
labor <- read.csv("/Users/amitsasson/PycharmProjects/DSSGx/final_dfs/labor_market_by_date.csv")
df <- df %>% left_join(labor, by = c("ags5" = "ags5", "ags2" = "ags2"))
df$ags2 <- factor(df$ags2)
df$ags5 <- factor(df$ags5)
df$cluster <- factor(df$cluster)

df <- df %>% 
        filter(variable == "unemployment_rate") %>% 
        select(-variable) %>% 
        rename(unemployment_rate = value) %>% 
        mutate(date = as.Date(as.character(date)))

head(df)
```

#### plot 
```{r}
ggplot(df, aes(x = date, y = unemployment_rate)) + 
  geom_point() 

df %>% 
  group_by(cluster, date) %>% 
  summarise(mean_unemployment_rate = sum(unemployment_rate %*% X2019_population)/sum(X2019_population)) %>% 
ggplot(aes(x = date, y = mean_unemployment_rate, color = cluster)) + 
  geom_point()  + 
  geom_line() 

df %>% 
  group_by(bundesland, date) %>% 
  summarise(mean_unemployment_rate = sum(unemployment_rate %*% X2019_population)/sum(X2019_population)) %>% 
ggplot(aes(x = date, y = mean_unemployment_rate, color = bundesland)) + 
  geom_point()  + 
  geom_line() 

df %>% 
ggplot(aes(x = date, y = unemployment_rate, color = cluster, group = ags5)) + 
  geom_point(alpha = 0.5)  + 
  geom_line(alpha = 0.5) +
  theme(legend.position = "none")
```

#### LMM 
```{r}
fit4 <- lmer(unemployment_rate ~ date + cluster + median_income + X2019_population + (1 | ags2) + (1 | ags5), df)
summary(fit4)

get_gof(fit4)
fit5 <- lmer(unemployment_rate ~ . + (1 | ags2) + (1 | ags5), df)

# step(fit5, keep.effs = "Assessor")
```

#### TIme series 
```{r}
```



